<html>

<link rel="stylesheet" type="text/css" href="{% static 'webtagging/css/bootstrap.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'webtagging/css/webtagging.css' %}" />

<script>window.jQuery || document.write('<script src="/static/3rdparty/jquery-1.7.2.js"><\/script><script src="{% static "webclient/javascript/jquery.form.js" %}"><\/script>')</script>

<link rel="stylesheet" href="{% static '3rdparty/jquery.chosen/chosen.css' %}" type="text/css" media="screen"/>
<script src="{% static '3rdparty/jquery.chosen/chosen.jquery.js' %}"></script>
<script src="{% static 'webtagging/js/show_tags_dialog.js' %}"></script>
<!-- In various places I could rely only on an HTML5 data- field, but testing shows that jQuery selection based on data field is much slower than class based (especially on IE)-->

<script>
$(function(){

    // Parse state object
    imageStates = {{ imageStates|safe }}
    var $submitButton = $("#updateAllForm input[type='submit']");

    // Our table form is 'ajax' - whole table content is updated from form submission
    $("#updateAllForm").ajaxForm({
        beforeSubmit: function() {
            // prevent submitting the form again while waiting
            $submitButton.attr('disabled', true);
        },
        dataType: "json",
        success: function(data) {


            // For each update, find the cell and update it's selected status
            for (var i in data.additions) {
                var imageId = data.additions[i][0];
                var tagId = data.additions[i][1];
                var tokenName = data.additions[i][2];
                $td = $('tr#image_' + imageId + ' .token_' + tokenName);
                $td.addClass('success');
                $td.append('<input class="serverselected" name="serverselected" type="hidden" value="' + imageId + '_' + tokenName + '"/>');

                // Get the tags from state and update
                var image = imageStates[imageId];
                var token = image.tokens[tokenName];
                var tags = [];
                if (token.tags) {
                    tags = token.tags;
                }
                tags.push(tagId);
                token.tags = tags;
            }

            for (var i in data.removals) {
                var imageId = data.removals[i][0];
                var tagId = data.removals[i][1];
                var tokenName = data.removals[i][2];
                $td = $('tr#image_' + imageId + ' .token_' + tokenName);
                $td.removeClass('success');
                $td.children('.serverselected').remove();

                // Get the tags from state and update
                var image = imageStates[imageId];
                var token = image.tokens[tokenName];
                var tags = token.tags;

                // Check the list of tags for a match
                if ( tags ) {
                    $.each(tags, function(k,v){
                        if (v == tagId) {
                            tags.splice(k,1);
                            return false;
                        }
                    });
                }
                
            }
  
            $submitButton.removeAttr('disabled');
        }
    });

    // Example how to use tags dialog
    // OME.show_tags_dialog(
    //     "{% url webtagging_list_tags %}",
    //     function(tags){
    //         console.log(tags);
    //     },
    //     {'new_tag_default':"MyNewTag"}
    // );

    $("#updateAllForm").on("click", "a.token", function(event){
        var $tokenLink = $(this),
            tokenText = $tokenLink.text(),
            $th = $tokenLink.parent();
        OME.show_tags_dialog({
            list_tags: "{% url webtagging_list_tags %}",
            create_tag: "{% url webtagging_create_tag %}",
            success: function(tags){
                console.log(tags);
                var tag = tags[0];
                $select = $("<select name='tokentag'></select>")
                    .append("<option value='" + tag.name + "_" + tag.id +"'>" + tag.name + "(" + tag.id + ")</option>");
                $th.empty().append($select);
            },
            'new_tag_default':tokenText}
        );
        return false;
    });

    $('#hidePathTokensToggle').change(function(){
        
        if ($(this).prop('checked')) {
            $("#token-table").removeClass('hidePathTokens');
        } else {
            $("#token-table").addClass('hidePathTokens');
        }
    });

    $('#hideExtTokensToggle').change(function(){
        
        if ($(this).prop('checked')) {
            $("#token-table").removeClass('hideExtTokens');
        } else {
            $("#token-table").addClass('hideExtTokens');
        }
    });
    
    $("#updateAllForm").on("change", ".tag-selector", function(event){
        // Get the name of the selected item so appropriate hidden field can be selected
        var selectedValue = $(this).val();

        // Create variables holding all the th elements so that this can be used to calculate the index
        var $th = $('#token-table > thead > tr > th');
        var $rows = $('#token-table > tbody > tr');

        // Get the position of the th element in which the selector is
        var colIndex = $th.index( $(this).parent() );

        // For each row
        $rows.each(function(i, v){
            // Get the imageId from the tr
            var imageId = $(v).data('imageid');

            // Get the td which corresponds to the index of the th above
            var $td = $(this).children().eq(colIndex);

            // Remove all the background highlights
            $td.removeClass('success');
            // Remove any serverselected markers
            $td.children('.serverselected').remove();

            if (selectedValue != '') {

                // Query the JSON State object to determine if the new mapping should be marked selected or not for this image
                var selectedValueSplit = selectedValue.split('_');
                var tagId = selectedValueSplit[selectedValueSplit.length-1];
                //TODO Build token from all but the last element of the selectedValueSplit
                var tokenName = selectedValueSplit[0];
                var image = imageStates[imageId];
                var token = image.tokens[tokenName];
                var tags = token.tags;

                // Check the list of tags for a match
                var found = false;
                if ( tags ) {
                    $.each(tags, function(k,v){
                        if (v == tagId) {
                            found = true;
                            return false;
                        }
                    });
                }
                // If a match was found, then add the hidden serverselected field
                if ( found ) {
                    $td.append('<input class="serverselected" name="serverselected" type="hidden" value="' + imageId + '_' + tokenName + '"/>');
                    $td.addClass('success');
                }

                // If a match was found or autoselect is set for this token, check the box
                if ( token.autoselect || found ) {
                    $td.children('.imagechecked').prop('checked', true);
                } else {
                    $td.children('.imagechecked').prop('checked', false);
                }


                $td.has("."+selectedValue).addClass('success');
            }
        });
    });

});

</script>

<div style="position:absolute; top:0px; left:0px; right:0px; height: 29px; border-right:0px" class="toolbar">
    Path: <input id="hidePathTokensToggle" name="hidePathTokensToggle" value="hidePathTokensToggle" type="checkbox" />
    Extensions: <input id="hideExtTokensToggle" name="hideExtTokensToggle" value="hideExtTokensToggle" type="checkbox" />
</div>
<div style="position:absolute; bottom:25px; left:0px; top:29px; overflow:auto; margin-top:0px; right:0px">
    <form id="updateAllForm" action="{% url webtagging_process_update %}" method="post">

        <table id="token-table" class="table table-bordered table-striped table-hover table-condensed hidePathTokens hideExtTokens">

        {% include "webtagging/tag_table.html" %}

        </table>
        <input type="submit" value="Apply" />
    </form>
</div>
</html>
